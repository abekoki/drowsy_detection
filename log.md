# プロジェクト作業ログ

## ===2025-08-05===

### 連続閉眼検知アルゴリズム仕様書作成
- **作業内容**: テンプレートとアルゴリズム概要を統合し、具体的な仕様書 `AS_drowsy_detection.md` を作成
- **対象ファイル**:
  - `algorithm_specification/アルゴリズム仕様書について.md`
  - `algorithm_specification/連続閉眼検知アルゴリズム.md`
  - `algorithm_specification/AS_drowsy_detection.md`
- **主なポイント**:
  - 11 セクション構成を維持しつつ、連続閉眼検知アルゴリズム固有の詳細を記載
  - 入力・出力仕様、パラメータ表、処理フロー (Mermaid) を追加
  - 性能・制約、セキュリティ、法的対応等の項目を具体化
  - 3.2 処理フローの Mermaid 図と擬似コードの HTML エンティティを修正

### 仕様書整合性修正
- **作業内容**: ユーザーによる大幅な書き直し後の整合性修正
- **対象ファイル**: `algorithm_specification/AS_drowsy_detection.md`
- **修正内容**:
  - 入力仕様: `timestamp` → `frame_num` (int型) に統一
  - 出力仕様: 擬似コードと使用例を `int` 型 (0/1/-1) に統一
  - セクション番号: 削除されたセクションに合わせて4,5に修正
  - 変更履歴: v1.0.1として修正内容を追記


## ===2025-08-06===

### アルゴリズムロジック変更
- **作業内容**: 左右それぞれの目で独立した閉眼判定に変更、両目閉眼状態の継続時間で判定するロジックに修正
- **対象ファイル**: 
  - `algorithm_specification/AS_drowsy_detection.md`
  - `README.md`
- **修正内容**:
  - パラメータ: `eye_close_threshold` → `left_eye_close_threshold`, `right_eye_close_threshold` に分離
  - アルゴリズム概要: 左右それぞれの目で独立した閉眼判定、両目閉眼状態の継続時間で判定
  - 処理フロー: Mermaid図を左右の目の判定フローに変更
  - 擬似コード: 左右それぞれの目の閉眼判定ロジックに変更
  - 核心アルゴリズム: 両方の目が閉眼状態の場合のみタイマー加算
  - README: パラメータを左右分離して記載
  - 変更履歴: v1.0.2として修正内容を追記

### 処理フロー修正
- **作業内容**: タイマーが閾値を超えている間は連続閉眼フラグをONに保持するロジックに変更
- **対象ファイル**: `algorithm_specification/AS_drowsy_detection.md`
- **修正内容**:
  - 処理フロー: Mermaid図を修正し、タイマーが閾値を超えている間は連続閉眼フラグをONに保持
  - 擬似コード: 両目が閉眼状態でない場合でも、タイマーが閾値を超えている間は連続閉眼状態を返すロジックに変更
  - バージョン: v1.0.3に更新
  - 変更履歴: v1.0.3として修正内容を追記

### 処理フロー大幅修正
- **作業内容**: ユーザーによる処理フローの大幅修正後の整合性確保
- **対象ファイル**: `algorithm_specification/AS_drowsy_detection.md`
- **修正内容**:
  - フローチャート: HTMLエンティティを修正、形状指定を削除、表記を統一
  - 擬似コード: 両目閉眼でない場合はタイマーをリセットして連続閉眼状態を解除するロジックに修正
  - 核心アルゴリズム: 両目が閉眼状態でない場合のタイマーリセット動作を明記
  - バージョン: v1.0.4に更新
  - 変更履歴: v1.0.4として修正内容を追記

### README.md作成
- **作業内容**: プロジェクト概要を記載したREADME.mdを作成
- **対象ファイル**: `README.md`
- **作成内容**:
  - プロジェクト概要と主な特徴
  - 技術仕様の概要（入力・出力・パラメータ）
  - 詳細仕様書へのリンク
  - 開発環境とプロジェクト構成
  - ライセンス・貢献セクション（プレースホルダー）

### アルゴリズム仕様書の構成要素整理
- **作業内容**: アルゴリズム仕様書を書く際に必要な構成要素を列挙・整理
- **対象ファイル**: `algorithm_specification/アルゴリズム仕様書について.md`
- **作業詳細**:
  - 空のファイルに包括的な構成要素を追加
  - 11の主要セクションに分類して整理
  - 各セクションの詳細項目を明記
- **構成要素**:
  1. 概要・目的（アルゴリズム名、目的・背景、適用範囲）
  2. 技術仕様（入力仕様、出力仕様、パラメータ）
  3. アルゴリズム詳細（処理フロー、核心アルゴリズム、エラーハンドリング）
  4. 性能・制約（計算量、精度・性能指標、制約事項）
  5. 実装仕様（開発環境、ファイル構成、テスト仕様）
  6. 使用例・サンプル（基本使用例、応用例、トラブルシューティング）
  7. 保守・運用（メンテナンス、監視・ログ、バックアップ・復旧）
  8. セキュリティ・プライバシー（セキュリティ要件、プライバシー保護）
  9. 法的・規制対応（準拠すべき規制、コンプライアンス）
  10. 参考資料（参考文献、関連文書）
  11. 変更履歴（バージョン履歴、レビュー履歴）
- **注意事項**: 第三者が理解できるよう専門用語の説明、図表・サンプルコードの活用、定期レビュー・更新、バージョン管理の徹底を明記

## ===2025-08-07===

### Python実装詳細設計書作成
- **作業内容**: アルゴリズム仕様書をベースにしたPythonモジュール実装の詳細設計書を作成
- **対象ファイル**: `specific_design/SD_drowsy_detection_python.md`
- **作成内容**:
  - システム構成とアーキテクチャ設計
  - 各モジュールの詳細設計（設定管理、データモデル、タイマー管理、目の状態管理、メインアルゴリズム、ログ機能、データ前処理）
  - テスト設計（単体テスト・統合テスト）
  - パフォーマンス設計とエラーハンドリング
  - 使用例とCLIエントリポイント
- **設計方針**:
  - モジュール化: 機能ごとに独立したクラス・モジュールに分割
  - 型安全性: Pydantic による入力検証と型チェック
  - エラーハンドリング: 堅牢なエラー処理とログ出力
  - テスト容易性: 単体テスト・統合テストの実装を考慮
- **主要モジュール**:
  - `config/`: 設定管理とデータ検証
  - `core/`: メインアルゴリズム、タイマー管理、目の状態管理
  - `utils/`: ログ機能、データ前処理
  - `cli/`: コマンドラインインターフェース
  - `tests/`: 単体テスト・統合テスト
  - `examples/`: 使用例
- **性能要件**: 30fps以上、メモリ100MB以下、Raspberry Pi 4でCPU使用率20%以下

### Python実装完了と動作確認
- **作業内容**: 詳細設計書に基づくPythonモジュールの完全実装と動作確認を完了
- **実装ファイル**: 
  - `source/` パッケージ全体（config, core, utils, cli）
  - `examples/` 使用例コード
  - `tests/` テストコード群
  - `docs/implementation_summary.md` 実装概要
- **動作確認内容**:
  - uvによる依存関係管理とパッケージビルド成功
  - 基本使用例の実行確認（眠気検知、エラーハンドリング、カスタム設定）
  - CLIインターフェースの動作確認（サンプルデータ生成・処理）
  - 眠気検知アルゴリズムの正常動作確認（1.03秒連続閉眼でアラート発報）
- **実装特徴**:
  - 設計書完全準拠の実装
  - Pydantic v2による型安全性
  - 包括的なテストカバレッジ
  - CLI・ライブラリ両方の使用形態をサポート
  - uvプロジェクト管理対応
- **パフォーマンス**: リアルタイム処理可能な高速実装を確認
- **次のステップ**: 実機テスト、さらなる最適化、GUI開発等が可能 

### プロジェクトフォルダ構造の整理
- **作業内容**: フォルダ名の整理とドキュメント配置の最適化
- **実施日**: 2025-08-08
- **作業詳細**:
  - **docsフォルダの整理**: `docs/implementation_summary.md`を`02_specific_design/`に移動し、docsフォルダを削除
  - **examplesフォルダの整理**: `examples/README.md`を新規作成し、各サンプルコードの説明を追加
  - **uv設定の修正**: `pyproject.toml`のパッケージパスを`source`から`03_source`に更新
  - **README.mdの更新**: プロジェクト構成図とリンクを新しいフォルダ構造に合わせて修正
- **修正ファイル**:
  - `pyproject.toml`: パッケージパスとスクリプトエントリポイントの修正
  - `README.md`: プロジェクト構成図と仕様書リンクの更新
  - `examples/README.md`: 新規作成、サンプルコードの説明を追加
- **整理後の構造**:
  ```
  drowsy_detection/
  ├── 01_algorithm_specification/  # アルゴリズム仕様書
  ├── 02_specific_design/          # 詳細設計書（docsから移動）
  ├── 03_source/                   # ソースコード
  ├── examples/                    # 使用例（README追加）
  ├── tests/                       # テストコード
  └── その他設定ファイル
  ```
- **効果**: フォルダ構造の論理的な整理、ドキュメント配置の最適化、開発者向けとユーザー向けドキュメントの明確な分離 

## ===2025-08-22===

### パッケージング・レイアウト移行（src化）とメタ更新
- 変更: `src/drowsy_detection/` を新設し、`config/`, `core/`, `utils/`, `cli/` を整備
- 依存: `numpy`, `pydantic` のみに整理（opencv除外）
- ビルド: `pyproject.toml` を setuptools 構成に変更、`drowsy-detect` エントリ追加
- 付帯: `MANIFEST.in` 追加、`.gitignore` 拡充、`LICENSE`(MIT), `CHANGELOG.md` 追加
- CI: Windows + py3.10/3.11 で `uv` + `pytest --cov` のworkflow追加
- README: インストール/CLI/構成図を現実装に更新
- テスト: env再作成後、段階実行（config→core→detector）で全テスト成功
