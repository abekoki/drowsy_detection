name: Display Commit Info

on:
  push:
    branches: [ "*" ]  # 全ブランチで実行

jobs:
  display-info:
    runs-on: self-hosted
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # 全履歴を取得
    
    - name: Verify Python installation
      shell: cmd
      run: |
        echo Python環境の確認中...
        python --version
        python -c "import sys; print(f'Python {sys.version}')"
        python -c "import tomllib; print('tomllib利用可能')"
        echo ✅ Python環境OK
    
    - name: Get commit information
      id: commit-info
      shell: cmd
      run: |
        python scripts/get_commit_info.py
    
    - name: Display information
      shell: cmd
      run: |
        set COMMIT_HASH=${{ steps.commit-info.outputs.commit_hash }}
        set COMMIT_SHORT=${{ steps.commit-info.outputs.commit_short }}
        set COMMIT_MESSAGE_B64=${{ steps.commit-info.outputs.commit_message_b64 }}
        set COMMIT_DATE=${{ steps.commit-info.outputs.commit_date }}
        set BRANCH_NAME=${{ steps.commit-info.outputs.branch_name }}
        set VERSION=${{ steps.commit-info.outputs.version }}
        set CHANGELOG_B64=${{ steps.commit-info.outputs.changelog_b64 }}
        python scripts/display_info.py
    
    - name: Save information to file
      shell: cmd
      run: |
        set COMMIT_HASH=${{ steps.commit-info.outputs.commit_hash }}
        set COMMIT_SHORT=${{ steps.commit-info.outputs.commit_short }}
        set COMMIT_MESSAGE_B64=${{ steps.commit-info.outputs.commit_message_b64 }}
        set COMMIT_DATE=${{ steps.commit-info.outputs.commit_date }}
        set BRANCH_NAME=${{ steps.commit-info.outputs.branch_name }}
        set VERSION=${{ steps.commit-info.outputs.version }}
        set CHANGELOG_B64=${{ steps.commit-info.outputs.changelog_b64 }}
        python scripts/display_info.py save
    
    - name: Upload commit info as artifact
      uses: actions/upload-artifact@v4
      with:
        name: commit-info-${{ steps.commit-info.outputs.commit_short }}
        path: commit_info.txt
        retention-days: 30
