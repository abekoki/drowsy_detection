name: Display Commit Info

on:
  push:
    branches: [ "*" ]  # å…¨ãƒ–ãƒ©ãƒ³ãƒã§å®Ÿè¡Œ

jobs:
  display-info:
    runs-on: self-hosted
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # å…¨å±¥æ­´ã‚’å–å¾—
    
    - name: Verify Python installation
      run: |
        python --version
        python -c "import sys; print(f'Python {sys.version}')"
    
    - name: Set up Python (fallback)
      if: failure()
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        check-latest: false
        update-environment: false
    
    - name: Get commit information
      id: commit-info
      run: |
        # ç›´è¿‘ã®ã‚³ãƒŸãƒƒãƒˆãƒãƒƒã‚·ãƒ¥ã‚’å–å¾—
        COMMIT_HASH=$(git rev-parse HEAD)
        COMMIT_SHORT=$(git rev-parse --short HEAD)
        
        # ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å–å¾—
        COMMIT_MESSAGE=$(git log -1 --pretty=format:"%s")
        
        # ã‚³ãƒŸãƒƒãƒˆæ—¥æ™‚ã‚’å–å¾—
        COMMIT_DATE=$(git log -1 --pretty=format:"%ci")
        
        # ãƒ–ãƒ©ãƒ³ãƒåã‚’å–å¾—
        BRANCH_NAME=$(git rev-parse --abbrev-ref HEAD)
        
        # ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±ã‚’å–å¾—ï¼ˆpyproject.tomlã‹ã‚‰ï¼‰
        VERSION=$(python -c "import tomllib; print(tomllib.load(open('pyproject.toml', 'rb'))['project']['version'])")
        
        # å¤‰æ›´ãƒ­ã‚°ã‚’ç”Ÿæˆï¼ˆç›´è¿‘5ã‚³ãƒŸãƒƒãƒˆï¼‰
        CHANGELOG=$(git log --oneline -5)
        
        # GitHub Actionsã®å‡ºåŠ›ã«è¨­å®š
        echo "commit_hash=$COMMIT_HASH" >> $GITHUB_OUTPUT
        echo "commit_short=$COMMIT_SHORT" >> $GITHUB_OUTPUT
        echo "commit_message=$COMMIT_MESSAGE" >> $GITHUB_OUTPUT
        echo "commit_date=$COMMIT_DATE" >> $GITHUB_OUTPUT
        echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "changelog<<EOF" >> $GITHUB_OUTPUT
        echo "$CHANGELOG" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
    
    - name: Display information
      run: |
        echo "=========================================="
        echo "ğŸ“‹ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæƒ…å ±"
        echo "=========================================="
        echo "ğŸ·ï¸  ãƒãƒ¼ã‚¸ãƒ§ãƒ³: ${{ steps.commit-info.outputs.version }}"
        echo "ğŸŒ¿ ãƒ–ãƒ©ãƒ³ãƒ: ${{ steps.commit-info.outputs.branch_name }}"
        echo "ğŸ“… å®Ÿè¡Œæ—¥æ™‚: $(date '+%Y-%m-%d %H:%M:%S JST')"
        echo ""
        echo "=========================================="
        echo "ğŸ”— ã‚³ãƒŸãƒƒãƒˆæƒ…å ±"
        echo "=========================================="
        echo "ğŸ“ ã‚³ãƒŸãƒƒãƒˆãƒãƒƒã‚·ãƒ¥: ${{ steps.commit-info.outputs.commit_hash }}"
        echo "ğŸ”– çŸ­ç¸®ãƒãƒƒã‚·ãƒ¥: ${{ steps.commit-info.outputs.commit_short }}"
        echo "ğŸ’¬ ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸: ${{ steps.commit-info.outputs.commit_message }}"
        echo "â° ã‚³ãƒŸãƒƒãƒˆæ—¥æ™‚: ${{ steps.commit-info.outputs.commit_date }}"
        echo ""
        echo "=========================================="
        echo "ğŸ“œ å¤‰æ›´ãƒ­ã‚°ï¼ˆç›´è¿‘5ã‚³ãƒŸãƒƒãƒˆï¼‰"
        echo "=========================================="
        echo "${{ steps.commit-info.outputs.changelog }}"
        echo ""
        echo "=========================================="
        echo "âœ… æƒ…å ±è¡¨ç¤ºå®Œäº†"
        echo "=========================================="
    
    - name: Save information to file
      run: |
        # æƒ…å ±ã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜
        echo "ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæƒ…å ±" > commit_info.txt
        echo "================" >> commit_info.txt
        echo "ãƒãƒ¼ã‚¸ãƒ§ãƒ³: ${{ steps.commit-info.outputs.version }}" >> commit_info.txt
        echo "ãƒ–ãƒ©ãƒ³ãƒ: ${{ steps.commit-info.outputs.branch_name }}" >> commit_info.txt
        echo "å®Ÿè¡Œæ—¥æ™‚: $(date '+%Y-%m-%d %H:%M:%S JST')" >> commit_info.txt
        echo "" >> commit_info.txt
        echo "ã‚³ãƒŸãƒƒãƒˆæƒ…å ±" >> commit_info.txt
        echo "============" >> commit_info.txt
        echo "ã‚³ãƒŸãƒƒãƒˆãƒãƒƒã‚·ãƒ¥: ${{ steps.commit-info.outputs.commit_hash }}" >> commit_info.txt
        echo "çŸ­ç¸®ãƒãƒƒã‚·ãƒ¥: ${{ steps.commit-info.outputs.commit_short }}" >> commit_info.txt
        echo "ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸: ${{ steps.commit-info.outputs.commit_message }}" >> commit_info.txt
        echo "ã‚³ãƒŸãƒƒãƒˆæ—¥æ™‚: ${{ steps.commit-info.outputs.commit_date }}" >> commit_info.txt
        echo "" >> commit_info.txt
        echo "å¤‰æ›´ãƒ­ã‚°ï¼ˆç›´è¿‘5ã‚³ãƒŸãƒƒãƒˆï¼‰" >> commit_info.txt
        echo "========================" >> commit_info.txt
        echo "${{ steps.commit-info.outputs.changelog }}" >> commit_info.txt
        
        echo "ğŸ“„ æƒ…å ±ã‚’ commit_info.txt ã«ä¿å­˜ã—ã¾ã—ãŸ"
        cat commit_info.txt
    
    - name: Upload commit info as artifact
      uses: actions/upload-artifact@v4
      with:
        name: commit-info-${{ steps.commit-info.outputs.commit_short }}
        path: commit_info.txt
        retention-days: 30
