name: Display Commit Info

on:
  push:
    branches: [ "*" ]  # å…¨ãƒ–ãƒ©ãƒ³ãƒã§å®Ÿè¡Œ

jobs:
  display-info:
    runs-on: self-hosted
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # å…¨å±¥æ­´ã‚’å–å¾—
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Get commit information
      id: commit-info
      run: |
        # ç›´è¿‘ã®ã‚³ãƒŸãƒƒãƒˆãƒãƒƒã‚·ãƒ¥ã‚’å–å¾—
        COMMIT_HASH=$(git rev-parse HEAD)
        COMMIT_SHORT=$(git rev-parse --short HEAD)
        
        # ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å–å¾—
        COMMIT_MESSAGE=$(git log -1 --pretty=format:"%s")
        
        # ã‚³ãƒŸãƒƒãƒˆæ—¥æ™‚ã‚’å–å¾—
        COMMIT_DATE=$(git log -1 --pretty=format:"%ci")
        
        # ãƒ–ãƒ©ãƒ³ãƒåã‚’å–å¾—
        BRANCH_NAME=$(git rev-parse --abbrev-ref HEAD)
        
        # ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±ã‚’å–å¾—ï¼ˆpyproject.tomlã‹ã‚‰ï¼‰
        VERSION=$(python -c "import tomllib; print(tomllib.load(open('pyproject.toml', 'rb'))['project']['version'])")
        
        # å¤‰æ›´ãƒ­ã‚°ã‚’ç”Ÿæˆï¼ˆç›´è¿‘5ã‚³ãƒŸãƒƒãƒˆï¼‰
        CHANGELOG=$(git log --oneline -5)
        
        # GitHub Actionsã®å‡ºåŠ›ã«è¨­å®š
        echo "commit_hash=$COMMIT_HASH" >> $GITHUB_OUTPUT
        echo "commit_short=$COMMIT_SHORT" >> $GITHUB_OUTPUT
        echo "commit_message=$COMMIT_MESSAGE" >> $GITHUB_OUTPUT
        echo "commit_date=$COMMIT_DATE" >> $GITHUB_OUTPUT
        echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "changelog<<EOF" >> $GITHUB_OUTPUT
        echo "$CHANGELOG" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
    
    - name: Display information
      run: |
        echo "=========================================="
        echo "ðŸ“‹ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæƒ…å ±"
        echo "=========================================="
        echo "ðŸ·ï¸  ãƒãƒ¼ã‚¸ãƒ§ãƒ³: ${{ steps.commit-info.outputs.version }}"
        echo "ðŸŒ¿ ãƒ–ãƒ©ãƒ³ãƒ: ${{ steps.commit-info.outputs.branch_name }}"
        echo "ðŸ“… å®Ÿè¡Œæ—¥æ™‚: $(date '+%Y-%m-%d %H:%M:%S JST')"
        echo ""
        echo "=========================================="
        echo "ðŸ”— ã‚³ãƒŸãƒƒãƒˆæƒ…å ±"
        echo "=========================================="
        echo "ðŸ“ ã‚³ãƒŸãƒƒãƒˆãƒãƒƒã‚·ãƒ¥: ${{ steps.commit-info.outputs.commit_hash }}"
        echo "ðŸ”– çŸ­ç¸®ãƒãƒƒã‚·ãƒ¥: ${{ steps.commit-info.outputs.commit_short }}"
        echo "ðŸ’¬ ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸: ${{ steps.commit-info.outputs.commit_message }}"
        echo "â° ã‚³ãƒŸãƒƒãƒˆæ—¥æ™‚: ${{ steps.commit-info.outputs.commit_date }}"
        echo ""
        echo "=========================================="
        echo "ðŸ“œ å¤‰æ›´ãƒ­ã‚°ï¼ˆç›´è¿‘5ã‚³ãƒŸãƒƒãƒˆï¼‰"
        echo "=========================================="
        echo "${{ steps.commit-info.outputs.changelog }}"
        echo ""
        echo "=========================================="
        echo "âœ… æƒ…å ±è¡¨ç¤ºå®Œäº†"
        echo "=========================================="
    
    - name: Save information to file
      run: |
        # æƒ…å ±ã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜
        cat > commit_info.txt << EOF
ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæƒ…å ±
================
ãƒãƒ¼ã‚¸ãƒ§ãƒ³: ${{ steps.commit-info.outputs.version }}
ãƒ–ãƒ©ãƒ³ãƒ: ${{ steps.commit-info.outputs.branch_name }}
å®Ÿè¡Œæ—¥æ™‚: $(date '+%Y-%m-%d %H:%M:%S JST')

ã‚³ãƒŸãƒƒãƒˆæƒ…å ±
============
ã‚³ãƒŸãƒƒãƒˆãƒãƒƒã‚·ãƒ¥: ${{ steps.commit-info.outputs.commit_hash }}
çŸ­ç¸®ãƒãƒƒã‚·ãƒ¥: ${{ steps.commit-info.outputs.commit_short }}
ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸: ${{ steps.commit-info.outputs.commit_message }}
ã‚³ãƒŸãƒƒãƒˆæ—¥æ™‚: ${{ steps.commit-info.outputs.commit_date }}

å¤‰æ›´ãƒ­ã‚°ï¼ˆç›´è¿‘5ã‚³ãƒŸãƒƒãƒˆï¼‰
========================
${{ steps.commit-info.outputs.changelog }}
EOF
        
        echo "ðŸ“„ æƒ…å ±ã‚’ commit_info.txt ã«ä¿å­˜ã—ã¾ã—ãŸ"
        cat commit_info.txt
    
    - name: Upload commit info as artifact
      uses: actions/upload-artifact@v4
      with:
        name: commit-info-${{ steps.commit-info.outputs.commit_short }}
        path: commit_info.txt
        retention-days: 30
