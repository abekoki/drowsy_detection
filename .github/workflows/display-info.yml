name: Display Commit Info

on:
  push:
    branches: [ "*" ]  # å…¨ãƒ–ãƒ©ãƒ³ãƒã§å®Ÿè¡Œ

jobs:
  display-info:
    runs-on: self-hosted
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # å…¨å±¥æ­´ã‚’å–å¾—
    
    - name: Verify Python installation
      shell: cmd
      run: |
        echo Pythonç’°å¢ƒã®ç¢ºèªä¸­...
        python --version
        python -c "import sys; print(f'Python {sys.version}')"
        python -c "import tomllib; print('tomllibåˆ©ç”¨å¯èƒ½')"
        echo âœ… Pythonç’°å¢ƒOK
    
    - name: Get commit information
      id: commit-info
      shell: cmd
      run: |
        REM ç›´è¿‘ã®ã‚³ãƒŸãƒƒãƒˆãƒãƒƒã‚·ãƒ¥ã‚’å–å¾—
        for /f %%i in ('git rev-parse HEAD') do set COMMIT_HASH=%%i
        for /f %%i in ('git rev-parse --short HEAD') do set COMMIT_SHORT=%%i
        
        REM ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å–å¾—ï¼ˆBase64ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã§å®‰å…¨ã«ï¼‰
        git log -1 --pretty=format:"%%s" > commit_message.txt
        python -c "import base64; print(base64.b64encode(open('commit_message.txt', 'rb').read()).decode('ascii'))" > commit_message_b64.txt
        set /p COMMIT_MESSAGE_B64=<commit_message_b64.txt
        
        REM ã‚³ãƒŸãƒƒãƒˆæ—¥æ™‚ã‚’å–å¾—
        git log -1 --pretty=format:"%%ci" > commit_date.txt
        set /p COMMIT_DATE=<commit_date.txt
        
        REM ãƒ–ãƒ©ãƒ³ãƒåã‚’å–å¾—
        for /f %%i in ('git rev-parse --abbrev-ref HEAD') do set BRANCH_NAME=%%i
        
        REM ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±ã‚’å–å¾—ï¼ˆpyproject.tomlã‹ã‚‰ï¼‰
        for /f %%i in ('python -c "import tomllib; print(tomllib.load(open(\"pyproject.toml\", \"rb\"))[\"project\"][\"version\"])"') do set VERSION=%%i
        
        REM å¤‰æ›´ãƒ­ã‚°ã‚’ç”Ÿæˆï¼ˆç›´è¿‘5ã‚³ãƒŸãƒƒãƒˆï¼‰
        git log --oneline -5 > changelog_temp.txt
        
        REM GitHub Actionsã®å‡ºåŠ›ã«è¨­å®šï¼ˆBase64ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã§å®‰å…¨ã«ï¼‰
        echo commit_hash=%COMMIT_HASH% >> %GITHUB_OUTPUT%
        echo commit_short=%COMMIT_SHORT% >> %GITHUB_OUTPUT%
        echo commit_message_b64=%COMMIT_MESSAGE_B64% >> %GITHUB_OUTPUT%
        echo commit_date=%COMMIT_DATE% >> %GITHUB_OUTPUT%
        echo branch_name=%BRANCH_NAME% >> %GITHUB_OUTPUT%
        echo version=%VERSION% >> %GITHUB_OUTPUT%
        echo changelog= >> %GITHUB_OUTPUT%
        type changelog_temp.txt >> %GITHUB_OUTPUT%
    
    - name: Display information
      shell: cmd
      run: |
        REM Base64ãƒ‡ã‚³ãƒ¼ãƒ‰ã•ã‚ŒãŸã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å–å¾—
        python -c "import base64; print(base64.b64decode('${{ steps.commit-info.outputs.commit_message_b64 }}').decode('utf-8'))" > decoded_message.txt
        set /p DECODED_MESSAGE=<decoded_message.txt
        
        echo ==========================================
        echo ğŸ“‹ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæƒ…å ±
        echo ==========================================
        echo ğŸ·ï¸  ãƒãƒ¼ã‚¸ãƒ§ãƒ³: ${{ steps.commit-info.outputs.version }}
        echo ğŸŒ¿ ãƒ–ãƒ©ãƒ³ãƒ: ${{ steps.commit-info.outputs.branch_name }}
        echo ğŸ“… å®Ÿè¡Œæ—¥æ™‚: %date% %time%
        echo.
        echo ==========================================
        echo ğŸ”— ã‚³ãƒŸãƒƒãƒˆæƒ…å ±
        echo ==========================================
        echo ğŸ“ ã‚³ãƒŸãƒƒãƒˆãƒãƒƒã‚·ãƒ¥: ${{ steps.commit-info.outputs.commit_hash }}
        echo ğŸ”– çŸ­ç¸®ãƒãƒƒã‚·ãƒ¥: ${{ steps.commit-info.outputs.commit_short }}
        echo ğŸ’¬ ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸: %DECODED_MESSAGE%
        echo â° ã‚³ãƒŸãƒƒãƒˆæ—¥æ™‚: ${{ steps.commit-info.outputs.commit_date }}
        echo.
        echo ==========================================
        echo ğŸ“œ å¤‰æ›´ãƒ­ã‚°ï¼ˆç›´è¿‘5ã‚³ãƒŸãƒƒãƒˆï¼‰
        echo ==========================================
        echo ${{ steps.commit-info.outputs.changelog }}
        echo.
        echo ==========================================
        echo âœ… æƒ…å ±è¡¨ç¤ºå®Œäº†
        echo ==========================================
    
    - name: Save information to file
      shell: cmd
      run: |
        REM Base64ãƒ‡ã‚³ãƒ¼ãƒ‰ã•ã‚ŒãŸã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å–å¾—
        python -c "import base64; print(base64.b64decode('${{ steps.commit-info.outputs.commit_message_b64 }}').decode('utf-8'))" > decoded_message.txt
        set /p DECODED_MESSAGE=<decoded_message.txt
        
        REM æƒ…å ±ã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜
        echo ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæƒ…å ± > commit_info.txt
        echo ================ >> commit_info.txt
        echo ãƒãƒ¼ã‚¸ãƒ§ãƒ³: ${{ steps.commit-info.outputs.version }} >> commit_info.txt
        echo ãƒ–ãƒ©ãƒ³ãƒ: ${{ steps.commit-info.outputs.branch_name }} >> commit_info.txt
        echo å®Ÿè¡Œæ—¥æ™‚: %date% %time% >> commit_info.txt
        echo. >> commit_info.txt
        echo ã‚³ãƒŸãƒƒãƒˆæƒ…å ± >> commit_info.txt
        echo ============ >> commit_info.txt
        echo ã‚³ãƒŸãƒƒãƒˆãƒãƒƒã‚·ãƒ¥: ${{ steps.commit-info.outputs.commit_hash }} >> commit_info.txt
        echo çŸ­ç¸®ãƒãƒƒã‚·ãƒ¥: ${{ steps.commit-info.outputs.commit_short }} >> commit_info.txt
        echo ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸: %DECODED_MESSAGE% >> commit_info.txt
        echo ã‚³ãƒŸãƒƒãƒˆæ—¥æ™‚: ${{ steps.commit-info.outputs.commit_date }} >> commit_info.txt
        echo. >> commit_info.txt
        echo å¤‰æ›´ãƒ­ã‚°ï¼ˆç›´è¿‘5ã‚³ãƒŸãƒƒãƒˆï¼‰ >> commit_info.txt
        echo ======================== >> commit_info.txt
        echo ${{ steps.commit-info.outputs.changelog }} >> commit_info.txt
        
        echo ğŸ“„ æƒ…å ±ã‚’ commit_info.txt ã«ä¿å­˜ã—ã¾ã—ãŸ
        type commit_info.txt
    
    - name: Upload commit info as artifact
      uses: actions/upload-artifact@v4
      with:
        name: commit-info-${{ steps.commit-info.outputs.commit_short }}
        path: commit_info.txt
        retention-days: 30
